---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/netbox_auto/config.py
  - src/netbox_auto/cli.py
  - config.example.yaml
autonomous: true
must_haves:
  truths:
    - "Config file is loaded and validated on startup"
    - "Missing config results in helpful error message"
  artifacts:
    - path: "src/netbox_auto/config.py"
      provides: "Config loading with Pydantic validation"
      contains: "pydantic"
    - path: "config.example.yaml"
      provides: "Example configuration file"
      contains: "mikrotik"
  key_links:
    - from: "src/netbox_auto/cli.py"
      to: "src/netbox_auto/config.py"
      via: "load_config() call"
      pattern: "load_config|get_config"
---

<objective>
Create configuration system with YAML loading and environment variable override.

Purpose: Enable tool to read credentials and settings from config file (CONF-01, CONF-02, CONF-03).
Output: Working config module wired into CLI startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/netbox_auto/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config module with Pydantic</name>
  <files>src/netbox_auto/config.py</files>
  <action>
    Create config.py with Pydantic models:

    MikroTikConfig: host, username, password, port (default 8728)
    ProxmoxConfig: host, username, password/token, verify_ssl
    NetBoxConfig: url, token
    UnboundConfig: hosts (list of {host, user, config_path})
    DatabaseConfig: path (default "netbox-auto.db")

    Main Config class containing all above sections.

    Use pydantic-settings for env var override:
    - Env prefix: NETBOX_AUTO_
    - Nested delimiter: __
    - Example: NETBOX_AUTO_MIKROTIK__PASSWORD overrides mikrotik.password

    load_config(path: Path | None = None) function:
    - Default path: ./config.yaml
    - Load YAML, validate with Pydantic
    - Return Config instance
    - Raise clear error if file missing or invalid

    Global _config: Config | None for caching loaded config.
    get_config() returns cached config or raises if not loaded.
  </action>
  <verify>python -c "from netbox_auto.config import Config; print(Config.model_fields.keys())"</verify>
  <done>Config module imports and shows all config sections</done>
</task>

<task type="auto">
  <name>Task 2: Create example config and wire into CLI</name>
  <files>config.example.yaml, src/netbox_auto/cli.py</files>
  <action>
    Create config.example.yaml with all sections, placeholder values, and comments:
    - mikrotik section with router connection details
    - proxmox section (optional, can be null)
    - netbox section with API URL and token placeholder
    - unbound section with list of DNS servers
    - database section with path

    Modify cli.py:
    - Add --config option to main app (default: config.yaml)
    - Add callback that loads config on startup
    - If config missing/invalid, print helpful error and exit
    - Store config path in typer.Context for commands to access

    Use typer.Option with envvar="NETBOX_AUTO_CONFIG" for config path.
  </action>
  <verify>netbox-auto --help shows --config option; netbox-auto discover shows config error</verify>
  <done>CLI loads config on startup, missing config shows clear error message</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cp config.example.yaml config.yaml` + edit with test values
- [ ] `netbox-auto discover` loads config without error
- [ ] Remove config.yaml, `netbox-auto discover` shows helpful error
- [ ] `NETBOX_AUTO_MIKROTIK__PASSWORD=secret netbox-auto discover` works (env override)
- [ ] `make ci` passes
</verification>

<success_criteria>

- Config loads from YAML file
- Missing config produces helpful error (not stack trace)
- Environment variables can override config values
- Example config file documents all options
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>

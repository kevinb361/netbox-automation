---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/netbox_auto/models.py
  - src/netbox_auto/database.py
  - src/netbox_auto/cli.py
autonomous: true
must_haves:
  truths:
    - "SQLite database is created on first run"
  artifacts:
    - path: "src/netbox_auto/models.py"
      provides: "SQLAlchemy models for staging database"
      contains: "SQLAlchemy"
    - path: "src/netbox_auto/database.py"
      provides: "Database initialization logic"
      contains: "create_all"
  key_links:
    - from: "src/netbox_auto/cli.py"
      to: "src/netbox_auto/database.py"
      via: "init_db() call"
      pattern: "init_db|get_session"
    - from: "src/netbox_auto/database.py"
      to: "src/netbox_auto/config.py"
      via: "database path from config"
      pattern: "get_config|config\\.database"
---

<objective>
Create SQLite staging database with SQLAlchemy models.

Purpose: Establish data persistence for discovered hosts (DATA-01).
Output: Database auto-creates on first CLI run, models ready for Phase 2 collectors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/netbox_auto/cli.py
@src/netbox_auto/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQLAlchemy models</name>
  <files>src/netbox_auto/models.py</files>
  <action>
    Create models.py with SQLAlchemy ORM models:

    Base = declarative_base()

    DiscoveryRun:
    - id (primary key)
    - started_at (datetime)
    - completed_at (datetime, nullable)
    - status (enum: running, completed, failed)

    Host:
    - id (primary key)
    - mac (string, unique, indexed) - primary correlation key
    - hostname (string, nullable)
    - ip_addresses (JSON list of IPs seen)
    - source (enum: dhcp, proxmox, scan, manual)
    - switch_port (string, nullable) - e.g., "switch1:ether5"
    - status (enum: pending, approved, rejected, pushed)
    - host_type (enum: server, workstation, iot, network, unknown)
    - first_seen (datetime)
    - last_seen (datetime)
    - discovery_run_id (foreign key to DiscoveryRun)
    - netbox_id (integer, nullable) - ID after push
    - notes (text, nullable)

    Use SQLAlchemy 2.0 style (Mapped, mapped_column).
  </action>
  <verify>python -c "from netbox_auto.models import Host, DiscoveryRun; print('Models OK')"</verify>
  <done>Models import without error, all fields defined</done>
</task>

<task type="auto">
  <name>Task 2: Create database module and wire into CLI</name>
  <files>src/netbox_auto/database.py, src/netbox_auto/cli.py</files>
  <action>
    Create database.py:
    - get_engine() returns SQLAlchemy engine using config.database.path
    - init_db() creates all tables if not exist
    - get_session() returns sessionmaker instance
    - Use sqlite:/// URL format

    Modify cli.py:
    - After loading config, call init_db() to ensure database exists
    - Database file created at path from config (default: netbox-auto.db)
    - Add brief log message: "Database initialized at {path}"

    Database should be created lazily - only when CLI actually runs a command.
  </action>
  <verify>rm -f netbox-auto.db && netbox-auto status && ls -la netbox-auto.db</verify>
  <done>Database file created automatically on first command run</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `rm -f netbox-auto.db` to ensure clean state
- [ ] `netbox-auto status` creates database file
- [ ] `sqlite3 netbox-auto.db ".tables"` shows host and discovery_run tables
- [ ] `sqlite3 netbox-auto.db ".schema host"` shows all columns
- [ ] `make ci` passes
</verification>

<success_criteria>

- SQLite database created on first CLI run
- All model tables created with correct schema
- Database path configurable via config file
- No errors on repeated runs (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>

---
phase: 02-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/collectors/__init__.py, src/netbox_auto/collectors/base.py, src/netbox_auto/collectors/dhcp.py, pyproject.toml]
autonomous: true

must_haves:
  truths:
    - "Collector base class/protocol exists for all collectors to follow"
    - "MikroTik DHCP collector can connect and retrieve lease data"
    - "DHCP leases are stored in Host table with source=dhcp"
  artifacts:
    - path: "src/netbox_auto/collectors/base.py"
      provides: "Base collector protocol"
      exports: [Collector, DiscoveredHost]
    - path: "src/netbox_auto/collectors/dhcp.py"
      provides: "MikroTik DHCP collector"
      exports: [DHCPCollector]
  key_links:
    - from: "collectors/dhcp.py"
      to: "librouteros"
      via: "connect() API call"
      pattern: "librouteros\\.connect"
    - from: "collectors/dhcp.py"
      to: "DiscoveredHost"
      via: "returns list of DiscoveredHost"
---

<objective>
Create collector framework and MikroTik DHCP collector.

Purpose: Establish the collector pattern and implement first data source (DHCP leases).
Output: Base collector protocol, DHCP collector implementation, librouteros dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

@src/netbox_auto/models.py
@src/netbox_auto/config.py
@src/netbox_auto/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collector framework</name>
  <files>src/netbox_auto/collectors/__init__.py, src/netbox_auto/collectors/base.py</files>
  <action>
Create collectors package with base protocol:

1. Create `src/netbox_auto/collectors/__init__.py` - package init exporting key classes
2. Create `src/netbox_auto/collectors/base.py`:
   - `DiscoveredHost` dataclass: mac (str), hostname (str|None), ip_addresses (list[str]), source (HostSource), switch_port (str|None)
   - `Collector` Protocol with:
     - `name: str` property
     - `collect() -> list[DiscoveredHost]` method
   - Use typing.Protocol for duck-typing (not ABC)

Keep simple - collectors return DiscoveredHost list, orchestrator handles DB persistence.
  </action>
  <verify>python -c "from netbox_auto.collectors.base import Collector, DiscoveredHost; print('OK')"</verify>
  <done>Base collector protocol defined, DiscoveredHost dataclass exists</done>
</task>

<task type="auto">
  <name>Task 2: Implement MikroTik DHCP collector</name>
  <files>src/netbox_auto/collectors/dhcp.py, pyproject.toml</files>
  <action>
1. Add `librouteros>=3.2` to pyproject.toml dependencies
2. Create `src/netbox_auto/collectors/dhcp.py`:
   - `DHCPCollector` class implementing Collector protocol
   - Constructor takes MikroTikConfig
   - `collect()` method:
     - Connect via `librouteros.connect(host, username, password, port=port)`
     - Query `/ip/dhcp-server/lease` path
     - Extract: mac-address, host-name, address, active-address
     - Convert to DiscoveredHost (normalize MAC to lowercase with colons)
     - Handle connection errors gracefully (log and return empty list)
   - Use context manager pattern for connection cleanup

API reference (librouteros):
```python
import librouteros
api = librouteros.connect(host=host, username=user, password=pwd, port=port)
leases = api.path('/ip/dhcp-server/lease')
for lease in leases:
    mac = lease.get('mac-address')
    hostname = lease.get('host-name')
    ip = lease.get('active-address') or lease.get('address')
api.close()
```

Only include active leases (those with an address).
  </action>
  <verify>python -c "from netbox_auto.collectors.dhcp import DHCPCollector; print('OK')" && pip install -e . --quiet</verify>
  <done>DHCPCollector can connect to MikroTik and return DHCP leases as DiscoveredHost list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds (librouteros installed)
- [ ] `python -c "from netbox_auto.collectors import DHCPCollector, DiscoveredHost"` works
- [ ] Collector protocol and dataclass properly typed (mypy passes if run)
</verification>

<success_criteria>

- Collector framework established
- DHCPCollector implemented using librouteros
- Dependencies added to pyproject.toml
- All imports work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-discovery/02-01-SUMMARY.md`
</output>

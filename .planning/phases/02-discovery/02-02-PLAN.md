---
phase: 02-discovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/collectors/proxmox.py, pyproject.toml]
autonomous: true

must_haves:
  truths:
    - "Proxmox collector can connect and retrieve VM inventory"
    - "VMs are returned with MAC, hostname, and IP addresses"
  artifacts:
    - path: "src/netbox_auto/collectors/proxmox.py"
      provides: "Proxmox VM collector"
      exports: [ProxmoxCollector]
  key_links:
    - from: "collectors/proxmox.py"
      to: "proxmoxer"
      via: "ProxmoxAPI connection"
      pattern: "ProxmoxAPI"
    - from: "collectors/proxmox.py"
      to: "DiscoveredHost"
      via: "returns list of DiscoveredHost"
---

<objective>
Implement Proxmox VM inventory collector.

Purpose: Discover VMs from Proxmox cluster with MAC addresses and IPs.
Output: ProxmoxCollector implementation, proxmoxer dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/netbox_auto/models.py
@src/netbox_auto/config.py
@src/netbox_auto/collectors/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Proxmox collector</name>
  <files>src/netbox_auto/collectors/proxmox.py, pyproject.toml, src/netbox_auto/collectors/__init__.py</files>
  <action>
1. Add `proxmoxer>=2.0` to pyproject.toml dependencies
2. Create `src/netbox_auto/collectors/proxmox.py`:
   - `ProxmoxCollector` class implementing Collector protocol
   - Constructor takes ProxmoxConfig
   - `collect()` method:
     - Connect via `ProxmoxAPI(host, user=username, password=password, verify_ssl=verify_ssl)`
     - Iterate nodes: `api.nodes.get()`
     - For each node, get VMs: `api.nodes(node).qemu.get()`
     - For each VM, get config: `api.nodes(node).qemu(vmid).config.get()`
     - Extract network interfaces (net0, net1, etc.) for MAC addresses
     - MAC format in Proxmox: "virtio=AA:BB:CC:DD:EE:FF,bridge=vmbr0"
     - Parse MAC from net config value
     - VM name from 'name' field
     - Handle agent data for IP if available: `api.nodes(node).qemu(vmid).agent.get('network-get-interfaces')`
     - Convert to DiscoveredHost with source=proxmox

API reference (proxmoxer):
```python
from proxmoxer import ProxmoxAPI
api = ProxmoxAPI(host, user=user, password=password, verify_ssl=False)
for node in api.nodes.get():
    for vm in api.nodes(node['node']).qemu.get():
        config = api.nodes(node['node']).qemu(vm['vmid']).config.get()
        # net0 = "virtio=AA:BB:CC:DD:EE:FF,bridge=vmbr0"
```

Handle connection/auth errors gracefully - log and return empty list.
  </action>
  <verify>python -c "from netbox_auto.collectors.proxmox import ProxmoxCollector; print('OK')" && pip install -e . --quiet</verify>
  <done>ProxmoxCollector can connect to Proxmox and return VMs as DiscoveredHost list</done>
</task>

<task type="auto">
  <name>Task 2: Update collectors package exports</name>
  <files>src/netbox_auto/collectors/__init__.py</files>
  <action>
Update `src/netbox_auto/collectors/__init__.py` to export ProxmoxCollector.

Ensure all collector classes are accessible from `netbox_auto.collectors`.
  </action>
  <verify>python -c "from netbox_auto.collectors import ProxmoxCollector; print('OK')"</verify>
  <done>ProxmoxCollector exported from collectors package</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds (proxmoxer installed)
- [ ] `python -c "from netbox_auto.collectors import ProxmoxCollector"` works
- [ ] Collector properly implements protocol (returns list[DiscoveredHost])
</verification>

<success_criteria>

- ProxmoxCollector implemented using proxmoxer
- Extracts MAC addresses from VM network config
- Dependencies added to pyproject.toml
- Exported from collectors package
</success_criteria>

<output>
After completion, create `.planning/phases/02-discovery/02-02-SUMMARY.md`
</output>

---
phase: 02-discovery
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/collectors/scanner.py, src/netbox_auto/config.py, pyproject.toml]
autonomous: true

must_haves:
  truths:
    - "Scanner can ARP scan configured subnets"
    - "Discovered hosts include MAC and IP addresses"
  artifacts:
    - path: "src/netbox_auto/collectors/scanner.py"
      provides: "Network ARP scanner"
      exports: [ScannerCollector]
  key_links:
    - from: "collectors/scanner.py"
      to: "scapy"
      via: "ARP scan"
      pattern: "srp.*ARP"
    - from: "collectors/scanner.py"
      to: "DiscoveredHost"
      via: "returns list of DiscoveredHost"
---

<objective>
Implement network subnet scanner for static IP discovery.

Purpose: Find hosts with static IPs not in DHCP leases via ARP scanning.
Output: ScannerCollector implementation, scapy dependency, scanner config.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/netbox_auto/models.py
@src/netbox_auto/config.py
@src/netbox_auto/collectors/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scanner configuration</name>
  <files>src/netbox_auto/config.py</files>
  <action>
Add scanner configuration to config.py:

1. Create `ScannerConfig` model:
   - `subnets: list[str]` - List of subnets to scan (CIDR notation, e.g., "192.168.1.0/24")
   - `timeout: float = 2.0` - ARP response timeout in seconds

2. Add to main `Config` class:
   - `scanner: ScannerConfig | None = Field(default=None, description="Network scanner configuration")`

This allows users to configure which subnets to scan in config.yaml.
  </action>
  <verify>python -c "from netbox_auto.config import ScannerConfig; print('OK')"</verify>
  <done>ScannerConfig model added with subnets list</done>
</task>

<task type="auto">
  <name>Task 2: Implement ARP scanner collector</name>
  <files>src/netbox_auto/collectors/scanner.py, pyproject.toml, src/netbox_auto/collectors/__init__.py</files>
  <action>
1. Add `scapy>=2.5` to pyproject.toml dependencies
2. Create `src/netbox_auto/collectors/scanner.py`:
   - `ScannerCollector` class implementing Collector protocol
   - Constructor takes ScannerConfig
   - `collect()` method:
     - For each subnet in config.subnets:
       - Use scapy ARP scan: `srp(Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(pdst=subnet), timeout=timeout, verbose=0)`
       - Extract responding hosts' MAC and IP
       - Convert to DiscoveredHost with source=scan
     - Handle permission errors gracefully (ARP requires root/admin)
     - Log warning if insufficient permissions

API reference (scapy):
```python
from scapy.all import ARP, Ether, srp

def scan_subnet(subnet: str, timeout: float) -> list[tuple[str, str]]:
    """Return list of (ip, mac) tuples."""
    ans, _ = srp(
        Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=subnet),
        timeout=timeout,
        verbose=0
    )
    return [(rcv.psrc, rcv.hwsrc) for snd, rcv in ans]
```

Note: ARP scanning requires elevated privileges. Log clear warning if PermissionError.
3. Update collectors/__init__.py to export ScannerCollector
  </action>
  <verify>python -c "from netbox_auto.collectors.scanner import ScannerCollector; print('OK')" && pip install -e . --quiet</verify>
  <done>ScannerCollector can ARP scan subnets and return discovered hosts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e .` succeeds (scapy installed)
- [ ] `python -c "from netbox_auto.collectors import ScannerCollector"` works
- [ ] Config includes scanner.subnets option
</verification>

<success_criteria>

- ScannerCollector implemented using scapy ARP
- ScannerConfig added to config system
- Dependencies added to pyproject.toml
- Exported from collectors package
</success_criteria>

<output>
After completion, create `.planning/phases/02-discovery/02-03-SUMMARY.md`
</output>

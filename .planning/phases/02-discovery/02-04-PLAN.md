---
phase: 02-discovery
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/collectors/switch.py, src/netbox_auto/config.py]
autonomous: true

must_haves:
  truths:
    - "Switch collector can query MikroTik switch MAC tables"
    - "MAC-to-port mappings are returned for correlation"
  artifacts:
    - path: "src/netbox_auto/collectors/switch.py"
      provides: "MikroTik switch MAC table collector"
      exports: [SwitchCollector]
  key_links:
    - from: "collectors/switch.py"
      to: "librouteros"
      via: "connect() to switch"
      pattern: "librouteros\\.connect"
---

<objective>
Implement MikroTik switch MAC table collector.

Purpose: Get switch port mappings for discovered hosts to enable cable records in NetBox.
Output: SwitchCollector implementation, switch config model.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/netbox_auto/models.py
@src/netbox_auto/config.py
@src/netbox_auto/collectors/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add switch configuration</name>
  <files>src/netbox_auto/config.py</files>
  <action>
Add switch configuration to config.py:

1. Create `SwitchConfig` model (separate from MikroTikConfig for router):
   - `host: str` - Switch hostname or IP
   - `username: str` - API username
   - `password: str = ""` - API password
   - `port: int = 8728` - API port
   - `name: str` - Friendly name for the switch (used in switch_port field)

2. Add to main `Config` class:
   - `switches: list[SwitchConfig] = Field(default_factory=list, description="MikroTik switches to query for MAC tables")`

This allows multiple switches to be configured (typical home lab has 1-3).
  </action>
  <verify>python -c "from netbox_auto.config import SwitchConfig; print('OK')"</verify>
  <done>SwitchConfig model added, supports multiple switches</done>
</task>

<task type="auto">
  <name>Task 2: Implement switch MAC table collector</name>
  <files>src/netbox_auto/collectors/switch.py, src/netbox_auto/collectors/__init__.py</files>
  <action>
Create `src/netbox_auto/collectors/switch.py`:
- `SwitchCollector` class (NOT implementing Collector protocol - returns MAC mappings, not hosts)
- Constructor takes list[SwitchConfig]
- `collect() -> dict[str, str]` method returns {mac: switch_port} mapping:
  - For each switch in config:
    - Connect via librouteros
    - Query `/interface/bridge/host` (CRS switches) or `/interface/ethernet/switch/host` (older)
    - Try both paths, use whichever returns data
    - Extract: mac-address, on-interface
    - Build mapping: mac -> "switch_name:port_name"
  - Combine mappings from all switches
  - Handle connection errors gracefully (log, continue to next switch)

API reference (librouteros for switch):
```python
api = librouteros.connect(host=host, username=user, password=pwd, port=port)

# Try bridge host table first (CRS series)
try:
    hosts = api.path('/interface/bridge/host')
    for host in hosts:
        mac = host.get('mac-address')
        port = host.get('on-interface')
except:
    # Fall back to switch host table
    hosts = api.path('/interface/ethernet/switch/host')
```

The SwitchCollector returns a dict, not DiscoveredHost list - it enriches existing hosts.
Update collectors/__init__.py to export SwitchCollector.
  </action>
  <verify>python -c "from netbox_auto.collectors.switch import SwitchCollector; print('OK')"</verify>
  <done>SwitchCollector can query MAC tables from MikroTik switches</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from netbox_auto.collectors import SwitchCollector"` works
- [ ] SwitchConfig supports multiple switches
- [ ] Collector returns MAC-to-port mapping dict
</verification>

<success_criteria>

- SwitchCollector implemented using librouteros
- Queries bridge/switch host tables
- Returns MAC-to-port mapping for correlation
- Supports multiple switches
</success_criteria>

<output>
After completion, create `.planning/phases/02-discovery/02-04-SUMMARY.md`
</output>

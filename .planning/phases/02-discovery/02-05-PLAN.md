---
phase: 02-discovery
plan: 05
type: execute
wave: 2
depends_on: ["02-01", "02-02", "02-03", "02-04"]
files_modified: [src/netbox_auto/discovery.py, src/netbox_auto/cli.py]
autonomous: true

must_haves:
  truths:
    - "`netbox-auto discover` runs all collectors"
    - "Hosts from different sources are merged by MAC"
    - "Discovery results are persisted to database"
    - "Switch port mappings are applied to hosts"
  artifacts:
    - path: "src/netbox_auto/discovery.py"
      provides: "Discovery orchestration and MAC correlation"
      exports: [run_discovery]
    - path: "src/netbox_auto/cli.py"
      provides: "discover command implementation"
      contains: "def discover"
  key_links:
    - from: "cli.py"
      to: "discovery.run_discovery"
      via: "discover command calls run_discovery"
      pattern: "run_discovery"
    - from: "discovery.py"
      to: "each collector"
      via: "collector.collect() calls"
      pattern: "\\.collect\\(\\)"
    - from: "discovery.py"
      to: "get_session"
      via: "database persistence"
      pattern: "get_session"
---

<objective>
Implement discovery orchestration with MAC-based host correlation.

Purpose: Wire collectors together, merge hosts by MAC, persist to database.
Output: Working `netbox-auto discover` command that populates staging DB.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

These summaries contain collector implementations:
@.planning/phases/02-discovery/02-01-SUMMARY.md
@.planning/phases/02-discovery/02-02-SUMMARY.md
@.planning/phases/02-discovery/02-03-SUMMARY.md
@.planning/phases/02-discovery/02-04-SUMMARY.md

@src/netbox_auto/models.py
@src/netbox_auto/config.py
@src/netbox_auto/database.py
@src/netbox_auto/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement discovery orchestration</name>
  <files>src/netbox_auto/discovery.py</files>
  <action>
Create `src/netbox_auto/discovery.py`:

1. `run_discovery()` function that:
   - Creates DiscoveryRun record (status=running)
   - Gets config and instantiates collectors based on what's configured:
     - DHCPCollector if mikrotik config exists
     - ProxmoxCollector if proxmox config exists
     - ScannerCollector if scanner config exists (and has subnets)
     - SwitchCollector if switches config exists
   - Runs each host collector, aggregates DiscoveredHost results
   - Runs SwitchCollector to get MAC-to-port mappings
   - Calls `_merge_and_persist(hosts, mac_to_port, discovery_run)`
   - Updates DiscoveryRun status to completed/failed
   - Returns summary stats (new hosts, updated hosts, total)

2. `_merge_and_persist()` function:
   - Groups hosts by MAC (handles same host from multiple sources)
   - For each unique MAC:
     - Check if host exists in DB
     - If exists: update (merge IP addresses, update last_seen, update switch_port)
     - If new: create Host record
     - Set discovery_run_id to current run
   - IP address merging: combine unique IPs from all sources
   - Source priority for hostname: dhcp > proxmox > scan (most specific first)

3. Handle errors gracefully:
   - If one collector fails, continue with others
   - Log collector failures but don't abort discovery
   - Mark DiscoveryRun as failed only if all collectors fail

Key logic for MAC merge:
```python
from collections import defaultdict

hosts_by_mac: dict[str, list[DiscoveredHost]] = defaultdict(list)
for host in all_hosts:
    hosts_by_mac[host.mac.lower()].append(host)

for mac, hosts in hosts_by_mac.items():
    # Merge IPs from all sources
    all_ips = set()
    for h in hosts:
        all_ips.update(h.ip_addresses)

    # Pick hostname (first non-None, prefer dhcp)
    hostname = None
    for source in [HostSource.DHCP, HostSource.PROXMOX, HostSource.SCAN]:
        for h in hosts:
            if h.source == source and h.hostname:
                hostname = h.hostname
                break

    # Apply switch port mapping
    switch_port = mac_to_port.get(mac)
```
  </action>
  <verify>python -c "from netbox_auto.discovery import run_discovery; print('OK')"</verify>
  <done>Discovery orchestration implemented with MAC correlation</done>
</task>

<task type="auto">
  <name>Task 2: Wire discover CLI command</name>
  <files>src/netbox_auto/cli.py</files>
  <action>
Update `discover()` command in cli.py:

1. Import and call `run_discovery()`
2. Display progress with typer output:
   - "Running discovery..." at start
   - "Collecting from MikroTik DHCP..." (if configured)
   - "Collecting from Proxmox..." (if configured)
   - "Scanning subnets..." (if configured)
   - "Querying switch MAC tables..." (if configured)
3. Display summary:
   - Total hosts discovered
   - New hosts added
   - Existing hosts updated
   - Any collection errors

Use rich console output (typer includes rich) for colored status.

Example output:
```
Running discovery...
  ✓ MikroTik DHCP: 45 hosts
  ✓ Proxmox: 12 VMs
  ✓ Network scan: 8 hosts
  ✓ Switch MAC tables: 52 mappings

Discovery complete:
  New hosts: 8
  Updated: 42
  Total: 50
```
  </action>
  <verify>netbox-auto discover --help</verify>
  <done>discover command calls run_discovery and displays results</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `netbox-auto discover --help` shows command
- [ ] Discovery orchestration runs all configured collectors
- [ ] Hosts are merged by MAC address
- [ ] Results persisted to database
</verification>

<success_criteria>

- `netbox-auto discover` runs all collectors
- MAC-based correlation merges hosts from multiple sources
- Discovery results stored in Host table
- Switch port mappings applied to hosts
- CLI shows progress and summary
</success_criteria>

<output>
After completion, create `.planning/phases/02-discovery/02-05-SUMMARY.md`
</output>

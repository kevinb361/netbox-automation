---
phase: 03-review
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/netbox.py, src/netbox_auto/config.py, pyproject.toml]
autonomous: true

must_haves:
  truths:
    - "Tool can connect to NetBox API and list devices"
    - "Tool can list VMs from NetBox"
    - "NetBox data can be fetched for comparison"
  artifacts:
    - path: "src/netbox_auto/netbox.py"
      provides: "NetBox API client wrapper"
      exports: [NetBoxClient, get_netbox_devices, get_netbox_vms]
  key_links:
    - from: "netbox.py"
      to: "pynetbox"
      via: "API connection"
      pattern: "pynetbox\\.api"
    - from: "netbox.py"
      to: "config.netbox"
      via: "credentials from config"
      pattern: "get_config"
---

<objective>
Create NetBox API client for device/VM listing.

Purpose: Enable comparison between discovered hosts and existing NetBox inventory.
Output: NetBox client module with device/VM fetch functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/netbox_auto/config.py
@src/netbox_auto/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pynetbox dependency</name>
  <files>pyproject.toml</files>
  <action>
    Add pynetbox>=7.0 to dependencies list
  </action>
  <verify>grep pynetbox pyproject.toml</verify>
  <done>pynetbox in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create NetBox client module</name>
  <files>src/netbox_auto/netbox.py</files>
  <action>
    1. Create NetBoxClient class:
       - __init__ takes url and token (or gets from config)
       - Uses pynetbox.api for connection
       - Lazy connection (connect on first use)
    2. Add get_devices() method:
       - Returns list of dicts with: id, name, primary_ip, device_type, status
       - Fetches from dcim.devices.all()
    3. Add get_vms() method:
       - Returns list of dicts with: id, name, primary_ip, status
       - Fetches from virtualization.virtual_machines.all()
    4. Add helper function get_netbox_client() that creates client from config
    5. Handle connection errors gracefully (log warning, return empty list)
  </action>
  <verify>python -c "from netbox_auto.netbox import NetBoxClient"</verify>
  <done>NetBox client can list devices and VMs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pynetbox in dependencies
- [ ] NetBoxClient imports without error
- [ ] get_devices and get_vms methods exist
</verification>

<success_criteria>

- NBRC-01: Tool can list existing devices from NetBox
- NetBox API client works with config credentials
- Graceful handling of connection errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-review/03-03-SUMMARY.md`
</output>

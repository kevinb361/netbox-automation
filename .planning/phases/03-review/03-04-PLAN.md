---
phase: 03-review
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-03"]
files_modified: [src/netbox_auto/reconcile.py, src/netbox_auto/web/app.py, src/netbox_auto/web/templates/reconcile.html]
autonomous: true

must_haves:
  truths:
    - "User can view comparison between discovered hosts and NetBox"
    - "New hosts (not in NetBox) are highlighted"
    - "Stale NetBox entries (not in discovery) are identified"
    - "NetBox devices can be imported to staging DB"
  artifacts:
    - path: "src/netbox_auto/reconcile.py"
      provides: "Reconciliation logic"
      exports: [reconcile_hosts, import_netbox_devices]
    - path: "src/netbox_auto/web/templates/reconcile.html"
      provides: "Reconciliation view"
  key_links:
    - from: "reconcile.py"
      to: "netbox.py"
      via: "fetch NetBox data"
      pattern: "get_devices|get_vms"
    - from: "reconcile.py"
      to: "database"
      via: "query discovered hosts"
      pattern: "get_session"
---

<objective>
Implement NetBox reconciliation and comparison view.

Purpose: Show user what's new vs what's already in NetBox, identify stale entries.
Output: Reconciliation module and web page showing comparison.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review/03-01-SUMMARY.md
@.planning/phases/03-review/03-03-SUMMARY.md

@src/netbox_auto/models.py
@src/netbox_auto/netbox.py
@src/netbox_auto/web/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reconciliation module</name>
  <files>src/netbox_auto/reconcile.py</files>
  <action>
    1. Create reconcile_hosts() function:
       - Fetch NetBox devices/VMs (uses netbox.py)
       - Fetch discovered hosts from staging DB
       - Match by MAC or IP address (NetBox primary_ip vs host IPs)
       - Return dict with:
         - new_hosts: discovered but not in NetBox
         - matched_hosts: in both (with NetBox ID)
         - stale_netbox: in NetBox but not in discovery
    2. Create import_netbox_devices() function:
       - Fetch devices/VMs from NetBox
       - Create Host records in staging DB with source=MANUAL
       - Set netbox_id on imported hosts
       - Skip if MAC already exists in DB
    3. Use dataclasses for structured return types
  </action>
  <verify>python -c "from netbox_auto.reconcile import reconcile_hosts, import_netbox_devices"</verify>
  <done>Reconciliation logic works</done>
</task>

<task type="auto">
  <name>Task 2: Add reconciliation web view</name>
  <files>src/netbox_auto/web/app.py, src/netbox_auto/web/templates/reconcile.html, src/netbox_auto/web/templates/base.html</files>
  <action>
    1. Add /reconcile GET route:
       - Calls reconcile_hosts()
       - Passes new_hosts, matched_hosts, stale_netbox to template
    2. Add /reconcile/import POST route:
       - Calls import_netbox_devices()
       - Redirects to /hosts with flash message
    3. Create reconcile.html template:
       - Three sections: New Hosts, Matched, Stale in NetBox
       - New hosts highlighted (green)
       - Stale highlighted (yellow/warning)
       - Import button to pull NetBox devices
    4. Update base.html nav to include Reconcile link
  </action>
  <verify>Run Flask, visit /reconcile, see comparison view</verify>
  <done>Reconciliation page shows comparison and import button</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] reconcile_hosts returns categorized hosts
- [ ] /reconcile page shows three categories
- [ ] Import button creates Host records from NetBox
</verification>

<success_criteria>

- NBRC-02: Tool compares discovered hosts with NetBox
- NBRC-03: Tool detects stale NetBox entries
- NBRC-04: Tool can import NetBox devices into staging DB
- Visual distinction between new/matched/stale
</success_criteria>

<output>
After completion, create `.planning/phases/03-review/03-04-SUMMARY.md`
</output>

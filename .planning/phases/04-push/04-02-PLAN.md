---
phase: 04-push
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/netbox_auto/dns.py, pyproject.toml]
autonomous: true

must_haves:
  truths:
    - "Tool can generate Unbound local-data config from hosts"
    - "Tool can push config to Unbound server via SSH"
    - "Tool can reload Unbound after config update"
  artifacts:
    - path: "src/netbox_auto/dns.py"
      provides: "Unbound DNS push functionality"
      exports: ["generate_unbound_config", "push_dns_config"]
  key_links:
    - from: "push_dns_config"
      to: "paramiko.SSHClient"
      via: "SSH connection to Unbound servers"
---

<objective>
Create DNS push module for Unbound servers via SSH.

Purpose: Update Unbound DNS with discovered host records.
Output: dns.py with generate_unbound_config() and push_dns_config() functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/netbox_auto/config.py
@src/netbox_auto/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paramiko dependency</name>
  <files>pyproject.toml</files>
  <action>
Add paramiko>=3.0 to dependencies list in pyproject.toml.
Paramiko is the standard SSH library for Python - simpler than asyncssh for synchronous use.
  </action>
  <verify>grep -q "paramiko" pyproject.toml && echo "Found"</verify>
  <done>paramiko added to dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create DNS push module</name>
  <files>src/netbox_auto/dns.py</files>
  <action>
Create src/netbox_auto/dns.py with:

1. generate_unbound_config(hosts: list[Host], domain: str = "lan") -> str
   - Generate Unbound local-data lines: local-data: "hostname.domain. A ip_address"
   - Include header comment with generation timestamp
   - One line per host/IP combination (hosts can have multiple IPs)

2. push_dns_config(config: str, dry_run: bool = False) -> list[str]
   - Read UnboundConfig from get_config()
   - For each host in config.unbound.hosts:
     - SSH connect using paramiko (key-based auth assumed)
     - Write config to host.config_path
     - Run "sudo unbound-control reload"
   - Return list of hosts updated
   - If dry_run=True, just log what would happen, don't connect

Use logging for progress. Raise on connection failure (push should fail loudly).
  </action>
  <verify>python -c "from netbox_auto.dns import generate_unbound_config, push_dns_config; print('OK')"</verify>
  <done>dns.py created with generate and push functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] paramiko added to pyproject.toml
- [ ] src/netbox_auto/dns.py created
- [ ] python -m py_compile src/netbox_auto/dns.py succeeds
- [ ] make lint passes
</verification>

<success_criteria>
- All tasks completed
- generate_unbound_config produces valid Unbound local-data format
- push_dns_config handles dry_run mode correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-push/04-02-SUMMARY.md`
</output>

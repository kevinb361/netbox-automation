---
phase: 04-push
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified: [src/netbox_auto/push.py, src/netbox_auto/cli.py]
autonomous: true

must_haves:
  truths:
    - "netbox-auto push creates NetBox devices for approved hosts"
    - "netbox-auto push creates cable records in NetBox"
    - "netbox-auto push updates Unbound DNS"
    - "netbox-auto push --dry-run previews without pushing"
    - "Pushed hosts are marked with status=pushed in database"
  artifacts:
    - path: "src/netbox_auto/push.py"
      provides: "Push orchestration"
      exports: ["push_approved_hosts"]
    - path: "src/netbox_auto/cli.py"
      provides: "push CLI command"
      contains: "@app.command"
  key_links:
    - from: "push_approved_hosts"
      to: "NetBoxClient"
      via: "create_device/create_vm/create_cable calls"
    - from: "push_approved_hosts"
      to: "push_dns_config"
      via: "DNS update after NetBox"
---

<objective>
Implement push command that orchestrates NetBox and DNS updates.

Purpose: Complete push workflow from approved hosts to NetBox + DNS.
Output: push.py orchestration module + CLI push command with dry-run support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-push/04-01-SUMMARY.md
@.planning/phases/04-push/04-02-SUMMARY.md

@src/netbox_auto/netbox.py
@src/netbox_auto/dns.py
@src/netbox_auto/cli.py
@src/netbox_auto/models.py
@src/netbox_auto/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create push orchestration module</name>
  <files>src/netbox_auto/push.py</files>
  <action>
Create src/netbox_auto/push.py with:

@dataclass
class PushResult:
    netbox_created: int
    cables_created: int
    dns_updated: list[str]
    errors: list[str]
    dry_run: bool

def push_approved_hosts(
    dry_run: bool = False,
    skip_netbox: bool = False,
    skip_dns: bool = False,
) -> PushResult:
    """Push approved hosts to NetBox and DNS."""

Flow:
1. Query DB for hosts with status=approved
2. If no approved hosts, return early with zeros
3. For each approved host:
   - Determine if device or VM (based on host_type or source=proxmox)
   - If not dry_run: create in NetBox (device or VM)
   - If switch_port set: create cable record
   - Mark host status=pushed, store netbox_id
4. Generate Unbound config from pushed hosts
5. If not skip_dns: push to Unbound servers
6. Return PushResult with counts

Handle errors per-host: log and continue, collect in errors list.
Transaction: don't mark pushed until NetBox creation succeeds.
  </action>
  <verify>python -c "from netbox_auto.push import push_approved_hosts, PushResult; print('OK')"</verify>
  <done>push.py created with push_approved_hosts function</done>
</task>

<task type="auto">
  <name>Task 2: Implement push CLI command</name>
  <files>src/netbox_auto/cli.py</files>
  <action>
Replace stub push command with real implementation:

@app.command()
def push(
    dry_run: Annotated[bool, typer.Option("--dry-run", "-n", help="Preview changes without pushing.")] = False,
    skip_netbox: Annotated[bool, typer.Option("--skip-netbox", help="Skip NetBox push.")] = False,
    skip_dns: Annotated[bool, typer.Option("--skip-dns", help="Skip DNS push.")] = False,
) -> None:
    """Push approved hosts to NetBox and update DNS."""

Display:
- Show "DRY RUN" banner if dry_run
- Show approved host count before starting
- Show progress (creating device X, creating cable Y)
- Show final summary (X devices, Y cables, Z DNS servers)
- Show errors if any

Use console.print with rich formatting like discover command.
  </action>
  <verify>netbox-auto push --help | grep -q "dry-run" && echo "Found"</verify>
  <done>push command implemented with dry-run support</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/netbox_auto/push.py created
- [ ] push CLI command works with --dry-run, --skip-netbox, --skip-dns
- [ ] python -m py_compile src/netbox_auto/push.py succeeds
- [ ] make lint passes
</verification>

<success_criteria>
- All tasks completed
- netbox-auto push --dry-run shows what would be pushed
- Pushed hosts have status=pushed in database
</success_criteria>

<output>
After completion, create `.planning/phases/04-push/04-03-SUMMARY.md`
</output>
